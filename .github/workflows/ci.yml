name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck on bootstrap.sh
        run: shellcheck bootstrap.sh

      - name: Run ShellCheck on macos/defaults.sh
        run: shellcheck macos/defaults.sh

      - name: Run ShellCheck on emacs/setup.sh
        run: shellcheck emacs/setup.sh

  test-dry-run:
    name: Test Dry Run (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test dry-run install all
        run: ./bootstrap.sh install --dry-run

      - name: Test dry-run upgrade all
        run: ./bootstrap.sh upgrade --dry-run

      - name: Test dry-run individual tasks
        run: |
          ./bootstrap.sh install homebrew --dry-run
          ./bootstrap.sh install packages --dry-run
          ./bootstrap.sh install macos --dry-run
          ./bootstrap.sh install shell --dry-run
          ./bootstrap.sh install wm --dry-run
          ./bootstrap.sh install devtools --dry-run

      - name: Test doctor help
        run: ./bootstrap.sh doctor --help

  test-homebrew:
    name: Test Homebrew Installation
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove Homebrew (if exists)
        run: |
          if command -v brew &> /dev/null; then
            echo "Homebrew found, keeping it for faster testing"
          fi
        continue-on-error: true

      - name: Run homebrew task
        run: ./bootstrap.sh install homebrew

      - name: Verify Homebrew installation
        run: |
          brew --version
          echo "Homebrew installed successfully"

  test-packages:
    name: Test Package Installation
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Homebrew is installed
        run: ./bootstrap.sh install homebrew

      - name: Test package installation
        run: FORMULA_ONLY=true ./bootstrap.sh install packages
        env:
          FORMULA_ONLY: true

      - name: Verify common packages
        run: |
          git --version
          fish --version
          rg --version

  test-help:
    name: Test Help and Usage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test help command
        run: |
          ./bootstrap.sh --help
          ./bootstrap.sh help
          ./bootstrap.sh -h

      - name: Test invalid action
        run: |
          if ./bootstrap.sh invalid-action; then
            echo "Should have failed!"
            exit 1
          fi
        continue-on-error: false

      - name: Test invalid task
        run: |
          if ./bootstrap.sh install invalid-task; then
            echo "Should have failed!"
            exit 1
          fi
        continue-on-error: false

      - name: Test invalid doctor check
        run: |
          if ./bootstrap.sh doctor invalid-check; then
            echo "Should have failed!"
            exit 1
          fi
        continue-on-error: false

  test-doctor:
    name: Test Doctor Command
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Homebrew is installed
        run: ./bootstrap.sh install homebrew

      - name: Test doctor brew check
        run: ./bootstrap.sh doctor brew
        continue-on-error: true

      - name: Test doctor shell check
        run: ./bootstrap.sh doctor shell
        continue-on-error: true

      - name: Test doctor all checks
        run: ./bootstrap.sh doctor
        continue-on-error: true

  test-syntax:
    name: Test Script Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: bash -n bootstrap.sh

      - name: Check macos/defaults.sh syntax
        run: bash -n macos/defaults.sh

      - name: Check emacs/setup.sh syntax
        run: bash -n emacs/setup.sh
